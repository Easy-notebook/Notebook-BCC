# Action System Refactoring Summary

## Overview

This document summarizes the comprehensive refactoring of the Notebook-BCC action system to address critical design flaws and improve clarity between Generating and Planning responsibilities.

## Key Changes

### 1. Actions Split (Generating vs Planning)

**Before**: 11 mixed actions combining content generation and planning
**After**: 7 Generating Actions + 6 Planning Updates (via context_update)

#### Generating Actions (Retained - 7 types)
Returned by Generating API for content creation:
- `ADD_ACTION` - Add text/code/hybrid cells
- `EXEC_CODE` - Execute code cells
- `IS_THINKING` - Show thinking indicator
- `FINISH_THINKING` - Remove thinking indicator
- `NEW_CHAPTER` - Create chapter markers
- `NEW_SECTION` - Create section markers
- `UPDATE_TITLE` - Update notebook title

#### Planning Updates (Moved to context_update - 6 types)
Returned by Planning API in `context_update` field:
- `workflow_update` - Update workflow template (replaces UPDATE_WORKFLOW)
- `stage_steps_update` - Update stage steps (replaces UPDATE_STEP_LIST)
- `progress_update` - Update hierarchical focus (详细分析文本) (NEW)
- `variables_update` - Update context variables
- `effects_update` - Update execution effects
- `targetAchieved` - Mark goal completion (replaces COMPLETE_STEP)

#### Deleted Actions (4 types)
- `COMPLETE_STEP` / `end_phase` → Replaced by Planning API `targetAchieved`
- `UPDATE_WORKFLOW` → Replaced by Planning API `workflow_update`
- `UPDATE_STEP_LIST` → Replaced by Planning API `stage_steps_update`
- `NEXT_EVENT` → Removed (unclear purpose, unused)

### 2. Context Simplification

**Before**: AIContext contained:
```python
self.variables: Dict[str, Any]
self.effect: Dict[str, List[str]]
self.to_do_list: List[str]  # ❌ Semantically wrong
self.section_progress: Dict
self.workflow_progress: Dict
```

**After**: AIContext simplified to:
```python
self.variables: Dict[str, Any]
self.effect: Dict[str, List[str]]
self.custom_context: Dict[str, Any]
# Progress and focus moved to state machine
```

### 3. Hierarchical Focus System

**Key Insight**: Focus is **detailed analysis text** generated by Planner, used to guide Generating API.

**Location**: `observation.location.progress.*.focus` (not in context)

**Structure**:
```python
{
  "progress": {
    "stages": {
      "completed": [
        {
          "stage_id": "stage1",
          "goal": "...",
          "outputs_produced": {...}
        }
      ],
      "current": "stage3",
      "remaining": ["stage4"],
      "focus": "【Stage 详细分析文本】\n\n## 阶段目标\n...",  # ← Planner 生成的详细文本
      "current_outputs": {
        "expected": ["df_cleaned", "cleaning_report"],
        "produced": [],
        "in_progress": []
      }
    },
    "steps": {
      "completed": [...],
      "current": "step2",
      "remaining": ["step3"],
      "focus": "【Step 详细执行方案】\n\n当前状态分析：...\n关键产出目标：...\n建议方法：...",  # ← Planner 生成的详细文本
      "current_outputs": {
        "expected": ["df", "missing_fill_report"],
        "produced": [],
        "in_progress": []
      }
    },
    "behaviors": {
      "completed": [...],
      "current": "behavior2",
      "iteration": 1,
      "focus": "【Behavior 详细指导】\n\n执行目标：...\n关键产出：...\n建议方法：...",  # ← Planner 生成的详细文本
      "current_outputs": {
        "expected": ["df_working", "imputation_log"],
        "produced": [],
        "in_progress": []
      }
    }
  }
}
```

**Focus Purpose**:
- Planner 生成详细分析文本，为 Generating API 提供上下文提示
- 包含：当前状态分析、关键产出目标、建议执行方法
- 不是变量名列表，不用于完成检查

### 4. Responsibility Clarification

| Responsibility | Owner | Mechanism |
|---------------|-------|-----------|
| Content Generation | Generating API | Returns action list |
| Goal Achievement Check | Planning API | Returns targetAchieved in context_update |
| Focus Management | Planning API | Updates progress.*.focus in context_update |
| Navigation Control | Client | Based on targetAchieved signal |
| Progress Calculation | Client | From workflow_template + context |

## Files Modified

### Core Layer
- **core/state_machine.py**: Added hierarchical focus fields and management methods
  - Added `_stage_focus`, `_step_focus`, `_behavior_focus` fields (详细文本类型)
  - Added `update_progress_focus()` method
  - Added output tracking: `_stage_outputs`, `_step_outputs`, `_behavior_outputs`
  - Updated `get_progress_info()` to include focus (详细文本) and current_outputs at each level

### Stores Layer
- **stores/ai_context_store.py**: Removed toDoList and progress tracking
  - Removed `to_do_list`, `section_progress`, `workflow_progress` fields
  - Removed all related methods (add_to_do_list, remove_from_to_do_list, etc.)
  - Simplified `to_dict()` to only return variables and effects

- **stores/script_store.py**: Reduced to 7 Generating Actions
  - Updated ACTION_TYPES from 11 to 7 actions
  - Added comments explaining removed actions
  - Removed handler registrations for deleted actions

- **stores/handlers/workflow_handlers.py**: Removed planning-related handlers
  - Removed `handle_complete_step()`
  - Removed `handle_update_workflow()`
  - Removed `handle_update_step_list()`
  - Kept only `handle_update_title()`

- **stores/handlers/__init__.py**: Updated imports
  - Removed imports for deleted handlers

## Design Principles

### 1. Planning-First Protocol
Always call Planning API before Generating API to ensure proper goal tracking.

### 2. Progress is Calculated, Not Stored
Progress is derived from:
- `workflow_template` (stages/steps structure)
- `context.current_stage_id`, `context.current_step_id`
- `context.completed_behaviors`

### 3. Focus is Detailed Analysis Text
Focus is detailed analysis text generated by Planner:
- ✅ `"【Behavior: 执行缺失值填充】\n\n## 当前状态分析\n...\n\n## 关键产出目标\n...\n\n## 建议方法\n..."`
- ❌ `["data_loaded", "schema_validated"]` (变量名列表)
- ❌ `["Load CSV file", "Validate schema"]` (任务描述列表)

### 4. Hierarchical Focus and Output Tracking
Three independent levels:
- **Stage Focus**: High-level detailed analysis for stage guidance
- **Step Focus**: Step-level detailed execution plan
- **Behavior Focus**: Fine-grained execution instructions
- Each level includes **current_outputs** tracking (expected/produced/in_progress)

### 5. Server Suggests, Client Controls
- Server suggests completion via `targetAchieved`
- Client makes final navigation decisions

## Migration Guide

### For API Response Handling

**Before**:
```python
for action in response['actions']:
    if action['action'] == 'end_phase':
        # Handle step completion
```

**After**:
```python
context_update = response.get('context_update', {})
if context_update.get('targetAchieved'):
    # Planning API suggests completion
    if state_machine.is_step_completed():
        # Client confirms and navigates
```

### For Context Building

**Before**:
```python
context = {
    'variables': ai_context.variables,
    'effects': ai_context.effect,
    'toDoList': ai_context.to_do_list  # ❌
}
```

**After**:
```python
context = {
    'variables': ai_context.variables,
    'effects': ai_context.effect,
    # Focus is in observation, not context
}
```

### For Progress Updates

**Before**:
```python
# Client updated progress directly
ai_context.workflow_progress = new_progress
```

**After**:
```python
# Server updates focus via context_update
progress_update = context_update.get('progress_update', {})
if progress_update:
    level = progress_update['level']  # "stages" | "steps" | "behaviors"
    focus = progress_update['focus']  # 详细分析文本 (字符串)
    state_machine.update_progress_focus(level, focus)
```

## Testing Checklist

- [ ] Test all 7 Generating Actions execute correctly
- [ ] Test Planning API context_update processing
- [ ] Test hierarchical focus updates (详细文本格式)
- [ ] Test output tracking at all levels (expected/produced/in_progress)
- [ ] Test navigation based on targetAchieved
- [ ] Test progress calculation accuracy
- [ ] Verify no references to deleted actions remain
- [ ] Verify toDoList completely removed

## Remaining Work

### Phase 3: API Client Modifications
- [ ] Update `core/state_effects/behavior_effects.py` to handle progress_update
- [ ] Update `utils/api_client.py` to remove toDoList references

### Phase 4: Documentation Updates
- [ ] Update `docs/API_PROTOCOL.md` with hierarchical focus structure
- [ ] Update `docs/ACTION_PROTOCOL.md` to document action changes

### Phase 5: Testing
- [ ] Run test suite
- [ ] Fix test failures
- [ ] Update test fixtures

## Benefits

1. **Clear Separation**: Generating vs Planning responsibilities are distinct
2. **Semantic Correctness**: Focus as variable names makes sense
3. **Hierarchical Tracking**: Three-level focus enables fine-grained control
4. **Simplified Context**: Removed redundant and confusing fields
5. **Extensible Design**: Easy to add new actions or focus levels
6. **POMDP Alignment**: Proper observation structure for planning

## References

- [ACTION_DESIGN_ANALYSIS.md](./ACTION_DESIGN_ANALYSIS.md) - Initial problem analysis
- [ACTION_REDESIGN.md](./ACTION_REDESIGN.md) - Dual-track design proposal
- [HIERARCHICAL_FOCUS_DESIGN.md](./HIERARCHICAL_FOCUS_DESIGN.md) - Focus system design
- [COMPLETE_REFACTORING_PLAN.md](./COMPLETE_REFACTORING_PLAN.md) - Implementation plan

---

**Refactored**: 2025-10-28
**Status**: Core implementation complete, API client updates pending
